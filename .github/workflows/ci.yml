name: CI

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: full
      SHUMA_FAIL_MODE: open
    steps:
      - name: Checkout
        name: CI

        on:
          push:
            branches: [ main ]
          pull_request:
            branches: [ main ]

        jobs:
          test:
            runs-on: ubuntu-latest
            env:
              RUST_BACKTRACE: full
              SHUMA_FAIL_MODE: open
            steps:
              - name: Checkout
                uses: actions/checkout@v4

              - name: Install Rust toolchain and target
                uses: actions-rs/toolchain@v1
                with:
                  toolchain: stable
                  target: wasm32-wasip1

              - name: Install dependencies
                run: |
                  sudo apt-get update && sudo apt-get install -y curl ca-certificates

              - name: Install Spin CLI
                run: |
                  curl -fsSL https://github.com/fermyon/spin/releases/latest/download/spin-linux-x86_64 -o /usr/local/bin/spin
                  sudo chmod +x /usr/local/bin/spin

              - name: Build wasm release
                run: |
                  cargo build --target wasm32-wasip1 --release
                  cp target/wasm32-wasip1/release/shuma_gorath.wasm src/bot_trap.wasm

              - name: Start Spin server (background)
                run: |
                  nohup spin up --listen 127.0.0.1:3000 > /tmp/spin.log 2>&1 &
                  for i in {1..30}; do
                    if curl -sS http://127.0.0.1:3000/health >/dev/null 2>&1; then
                      echo "spin ready"; break
                    fi
                    sleep 1
                  done

              - name: Run full test suite
                run: make test

              - name: Upload Spin logs (on failure)
                if: failure()
                uses: actions/upload-artifact@v4
                with:
                  name: spin-log
                  path: /tmp/spin.log

